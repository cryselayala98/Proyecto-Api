<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestHistoryHandlerFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">api</a> &gt; <a href="index.source.html" class="el_package">crisel.ayala.api.utilities.interceptor</a> &gt; <span class="el_source">RequestHistoryHandlerFilter.java</span></div><h1>RequestHistoryHandlerFilter.java</h1><pre class="source lang-java linenums">package crisel.ayala.api.utilities.interceptor;

import crisel.ayala.api.configuration.WebConfig;
import crisel.ayala.api.model.HistoryCall;
import crisel.ayala.api.model.Response;
import crisel.ayala.api.service.HistoryCallService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.reactivestreams.Publisher;
import org.springframework.core.io.buffer.DataBuffer;
import org.springframework.core.io.buffer.DataBufferFactory;
import org.springframework.core.io.buffer.DataBufferUtils;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.http.server.reactive.ServerHttpResponseDecorator;
import org.springframework.web.server.ResponseStatusException;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

<span class="fc" id="L30">@Slf4j</span>
@RequiredArgsConstructor
public class RequestHistoryHandlerFilter implements WebFilter {

    private final HistoryCallService historyCallService;

    private final WebConfig webConfig;

    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, WebFilterChain chain) {


<span class="nc" id="L42">        String pathInvoke = exchange.getRequest().getURI().getPath();</span>

<span class="nc" id="L44">        log.info(&quot;Starting analysis for {}&quot;, pathInvoke);</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if(pathIsExcluded(pathInvoke)){</span>
<span class="nc" id="L46">            log.info(&quot;{} ignored {} for analysis&quot;, this.getClass().getName(), pathInvoke);</span>
<span class="nc" id="L47">            return chain.filter(exchange);</span>
        }


<span class="nc" id="L51">        HistoryCall historyCall = createHistoryDataAndSave(exchange);</span>
<span class="nc" id="L52">        return chain.filter(exchange).</span>
<span class="nc" id="L53">                onErrorResume(ex -&gt;  handleException(exchange, ex, historyCall))</span>
<span class="nc" id="L54">                .then(Mono.defer(() -&gt; handleResponse(exchange, chain, historyCall)));</span>
    }

    private Mono&lt;Void&gt; handleException(ServerWebExchange exchange, Throwable ex, HistoryCall historyCall) {

<span class="nc" id="L59">        HttpStatus status = HttpStatus.INTERNAL_SERVER_ERROR;</span>
<span class="nc" id="L60">        String trace = ex.getMessage();</span>

<span class="nc bnc" id="L62" title="All 2 branches missed.">        if(ex instanceof ResponseStatusException){</span>
<span class="nc" id="L63">            status = HttpStatus.resolve(((ResponseStatusException) ex).getStatusCode().value());</span>
<span class="nc" id="L64">            trace = ((ResponseStatusException) ex).getReason();</span>
<span class="nc" id="L65">            updateResponseAndSave(Optional.of((ResponseStatusException)ex), exchange, historyCall);</span>
        }
<span class="nc" id="L67">        exchange.getResponse().setStatusCode(status);</span>
<span class="nc" id="L68">        exchange.getResponse().getHeaders().setContentType(MediaType.APPLICATION_JSON);</span>

<span class="nc" id="L70">        String jsonError = String.format(&quot;{\n\tmessage: \&quot;%s\&quot;, \n\ttrace: \&quot;%s\&quot; \n}&quot;, status.toString(), trace);</span>

<span class="nc" id="L72">        DataBuffer dataBuffer = exchange.getResponse()</span>
<span class="nc" id="L73">                .bufferFactory()</span>
<span class="nc" id="L74">                .wrap(jsonError.getBytes(StandardCharsets.UTF_8));</span>

<span class="nc" id="L76">        return exchange.getResponse().writeWith(Mono.just(dataBuffer));</span>
    }

    private Mono&lt;Void&gt; handleResponse(ServerWebExchange exchange, WebFilterChain chain, HistoryCall historyCall) {
<span class="nc" id="L80">        Response response = historyCall.getResponse();</span>
<span class="nc" id="L81">        ServerHttpResponse httpResponse = exchange.getResponse();</span>
<span class="nc" id="L82">        String message = &quot;&quot;;</span>
<span class="nc" id="L83">        DataBufferFactory bufferFactory = httpResponse.bufferFactory();</span>

<span class="nc" id="L85">        ServerHttpResponseDecorator decoratedResponse = new ServerHttpResponseDecorator(httpResponse) {</span>
            @Override
            public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) {
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (body instanceof Flux) {</span>
<span class="nc" id="L89">                    Flux&lt;? extends DataBuffer&gt; fluxBody = (Flux&lt;? extends DataBuffer&gt;) body;</span>

<span class="nc" id="L91">                    return super.writeWith(fluxBody</span>
<span class="nc" id="L92">                            .flatMap(dataBuffer -&gt; {</span>
<span class="nc" id="L93">                                byte[] content = new byte[dataBuffer.readableByteCount()];</span>
<span class="nc" id="L94">                                dataBuffer.read(content);</span>
<span class="nc" id="L95">                                DataBufferUtils.release(dataBuffer);</span>

<span class="nc" id="L97">                                String responseBody = new String(content, StandardCharsets.UTF_8);</span>
<span class="nc" id="L98">                                log.info(&quot;Intercepted Response: &quot; + responseBody);</span>


<span class="nc" id="L101">                                byte[] newContent = responseBody.toUpperCase().getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L102">                                DataBuffer newBuffer = bufferFactory.wrap(newContent);</span>

<span class="nc" id="L104">                                return Mono.just(newBuffer);</span>
                            })
                    );
                }
<span class="nc" id="L108">                return super.writeWith(body);</span>
            }

            @Override
            public Mono&lt;Void&gt; writeAndFlushWith(Publisher&lt;? extends Publisher&lt;? extends DataBuffer&gt;&gt; body) {
<span class="nc" id="L113">                return super.writeAndFlushWith(body);</span>
            }
        };

<span class="nc bnc" id="L117" title="All 2 branches missed.">        if(HttpStatus.Series.valueOf(response.getCode()) != HttpStatus.Series.SERVER_ERROR &amp;&amp;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                HttpStatus.Series.valueOf(response.getCode()) != HttpStatus.Series.CLIENT_ERROR){</span>
<span class="nc" id="L119">            response = updateResponseAndSave(Optional.of(null), exchange, historyCall);</span>
        }

<span class="nc" id="L122">        return chain.filter(exchange.mutate().response(decoratedResponse).build())</span>
<span class="nc" id="L123">                .doOnSuccess(aVoid -&gt; System.out.println(&quot;Response processing completed&quot;));</span>
    }

    private HistoryCall createHistoryDataAndSave(ServerWebExchange exchange){
<span class="nc" id="L127">        log.info(&quot;Recolecting data from request....&quot;);</span>
<span class="nc" id="L128">        HistoryCall historyCall = this.constructHistoryData(exchange);</span>
<span class="nc" id="L129">        return historyCallService.save(historyCall);</span>
    }

    private HistoryCall constructHistoryData(ServerWebExchange exchange) {

<span class="nc" id="L134">        String fromIp = exchange.getRequest().getHeaders().getFirst(&quot;X-Forwarded-For&quot;);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (fromIp == null) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (exchange.getRequest().getRemoteAddress() != null) {</span>
<span class="nc" id="L137">                fromIp = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();</span>
<span class="nc" id="L138">            } else fromIp = &quot;unknown&quot;;</span>
        }

<span class="nc" id="L141">        Response response = constructResponse();</span>
<span class="nc" id="L142">        return HistoryCall.builder()</span>
<span class="nc" id="L143">                        .method(exchange.getRequest().getMethod().name())</span>
<span class="nc" id="L144">                        .url(exchange.getRequest().getURI().toString())</span>
<span class="nc" id="L145">                        .params(exchange.getRequest().getQueryParams()</span>
<span class="nc" id="L146">                                .entrySet()</span>
<span class="nc" id="L147">                                .stream()</span>
<span class="nc" id="L148">                                .map(entry -&gt; entry.getKey() + &quot;=&quot; + String.join(&quot;,&quot;, entry.getValue()))</span>
<span class="nc" id="L149">                                .collect(Collectors.joining(&quot;&amp;&quot;)))</span>
<span class="nc" id="L150">                        .ipFrom(fromIp)</span>
<span class="nc" id="L151">                        .timeCreated(LocalDateTime.now())</span>
<span class="nc" id="L152">                        .response(response)</span>
<span class="nc" id="L153">                        .build();</span>
    }

    private Response updateResponseAndSave(Optional&lt;ResponseStatusException&gt; ex, ServerWebExchange exchange, HistoryCall historyCall){
<span class="nc" id="L157">        Response responseModel = constructResponse(ex, exchange);</span>
<span class="nc" id="L158">        responseModel.setId(historyCall.getResponse().getId());</span>
<span class="nc" id="L159">        historyCall.setResponse(responseModel);</span>

<span class="nc" id="L161">        log.info(&quot;Updating History when Response received...&quot;);</span>
<span class="nc" id="L162">        historyCallService.save(historyCall);</span>

<span class="nc" id="L164">        return historyCall.getResponse();</span>
    }
    private Response constructResponse(){
<span class="nc" id="L167">        return Response.builder()</span>
<span class="nc" id="L168">                .code(200)</span>
<span class="nc" id="L169">                .message(&quot;OK&quot;)</span>
<span class="nc" id="L170">                .build();</span>
    }
    private Response constructResponse(Optional&lt;ResponseStatusException&gt; ex, ServerWebExchange exchange) {

<span class="nc" id="L174">        int codeStatus = exchange.getResponse().getStatusCode().value();</span>
<span class="nc" id="L175">        HttpStatus status = HttpStatus.resolve(codeStatus);</span>
<span class="nc" id="L176">        String message = exchange.toString();</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (ex.isPresent()) {</span>
<span class="nc" id="L179">            codeStatus = ex.get().getStatusCode().value();</span>
<span class="nc" id="L180">            status = HttpStatus.resolve(codeStatus);</span>
<span class="nc" id="L181">            message = ex.get().getMessage();</span>
        }

<span class="nc" id="L184">        return Response.builder()</span>
<span class="nc" id="L185">                .code(codeStatus)</span>
<span class="nc" id="L186">                .message(status.toString())</span>
<span class="nc" id="L187">                .trace(message)</span>
<span class="nc" id="L188">                .build();</span>
    }

    private boolean pathIsExcluded(String pathInvoke){
<span class="nc" id="L192">        List&lt;String&gt; excludedPaths = webConfig.getExcludedPaths();</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">        return excludedPaths != null &amp;&amp; excludedPaths.stream().anyMatch(pathInvoke::contains);</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>